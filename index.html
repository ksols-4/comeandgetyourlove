<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ìŠ¤íŒŒë¥´íƒ€í”Œë¦­ìŠ¤ - ê¸°ëŠ¥ì™„ì„±</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: black;
            font-family: "Nanum Myeongjo", serif;
            color: white;
        }

        .mypostingbox {
            width: 500px;
            margin: 20px auto;
            border: 1px solid white;
            padding: 20px;
            border-radius: 5px;
            background-color: #222;
        }

        .form-floating>input,
        .form-floating>label,
        .form-floating>select {
            background-color: transparent;
            color: white;
        }

        .mycards {
            width: 1200px;
            margin: 20px auto;
        }

        .comment {
            background-color: #333;
            margin-left: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 14px;
        }

        .comment .reply-btn,
        .comment .delete-comment-btn {
            cursor: pointer;
            color: #0d6efd;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .comment .delete-comment-btn {
            color: #dc3545;
        }

        .comment-input,
        .reply-textarea {
            background-color: #222;
            color: white;
            border: 1px solid #444;
            width: 100%;
            resize: vertical;
        }

        .like-btn,
        .dislike-btn {
            cursor: pointer;
            user-select: none;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            query,
            where,
            orderBy,
            serverTimestamp,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAq1RQ-m7-KrkkvzAUpT0dpOXMTr2ueLmc",
            authDomain: "sparta-c3b63.firebaseapp.com",
            projectId: "sparta-c3b63",
            storageBucket: "sparta-c3b63.firebasestorage.app",
            messagingSenderId: "579734391937",
            appId: "1:579734391937:web:130ae0731ce3b14e311180",
            measurementId: "G-VRFCKQZZDS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let editingId = null;
        let moviesData = [];

        // DOM jQuery ë³€ìˆ˜
        const $cardsContainer = $('#card');
        const $postingBox = $('#postingbox');
        const $btnPosting = $('#postingbtn');
        const $btnSave = $('#savebtn');

        const $inputImage = $('#image');
        const $inputTitle = $('#title');
        const $inputStar = $('#star');
        const $inputComment = $('#comment');

        // ê²€ìƒ‰, í•„í„°, ì •ë ¬ UI (ì¶”ê°€)
        $('body').prepend(`
      <div class="container my-3 text-white">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" class="form-control mb-2" />
        <select id="filterStar" class="form-select mb-2">
          <option value="all">ì „ì²´ ë³„ì </option>
          <option value="5">â­â­â­â­â­ë§Œ</option>
          <option value="4">â­â­â­â­ ì´ìƒ</option>
          <option value="3">â­â­â­ ì´ìƒ</option>
        </select>
        <select id="sortSelect" class="form-select mb-3">
          <option value="latest">ìµœì‹ ìˆœ</option>
          <option value="star">ë³„ì ìˆœ</option>
          <option value="likes">ì¢‹ì•„ìš”ìˆœ</option>
        </select>
      </div>
    `);

        const $searchInput = $('#searchInput');
        const $filterStar = $('#filterStar');
        const $sortSelect = $('#sortSelect');

        // ì €ì¥ or ìˆ˜ì • ë²„íŠ¼ í´ë¦­
        $btnPosting.on('click', async () => {
            const image = $inputImage.val().trim();
            const title = $inputTitle.val().trim();
            const star = $inputStar.val();
            const comment = $inputComment.val().trim();

            if (!image || !title || !star || star === 'ë³„ì ì„ íƒ') {
                alert('ì´ë¯¸ì§€, ì œëª©, ë³„ì ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.');
                return;
            }

            const docData = {
                image,
                title,
                star,
                comment,
                likes: 0,
                dislikes: 0,
                createdAt: serverTimestamp()
            };

            if (editingId) {
                // ìˆ˜ì •
                await updateDoc(doc(db, "movies", editingId), docData);
                alert("ìˆ˜ì • ì™„ë£Œ!");
                editingId = null;
            } else {
                // ìƒˆë¡œ ì €ì¥
                await addDoc(collection(db, "movies"), docData);
                alert("ì €ì¥ ì™„ë£Œ!");
            }

            clearForm();
            $postingBox.hide();
            await loadMovies();
        });

        // í¼ ì´ˆê¸°í™” í•¨ìˆ˜
        function clearForm() {
            $inputImage.val('');
            $inputTitle.val('');
            $inputStar.val('ë³„ì ì„ íƒ');
            $inputComment.val('');
            editingId = null;
        }

        // ì €ì¥í¼ í† ê¸€
        $btnSave.on('click', () => {
            if ($postingBox.is(':visible')) {
                $postingBox.hide();
                clearForm();
            } else {
                $postingBox.show();
            }
        });

        // ì˜í™” ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMovies() {
            $cardsContainer.empty();
            const snapshot = await getDocs(collection(db, "movies"));
            moviesData = [];
            snapshot.forEach(docSnap => {
                moviesData.push({ id: docSnap.id, ...docSnap.data() });
            });
            applyFiltersAndRender();
        }

        // ê²€ìƒ‰, í•„í„°, ì •ë ¬ ì ìš© í›„ ë Œë”ë§
        function applyFiltersAndRender() {
            let filtered = [...moviesData];

            // ê²€ìƒ‰
            const keyword = $searchInput.val().toLowerCase();
            if (keyword) {
                filtered = filtered.filter(m =>
                    m.title.toLowerCase().includes(keyword) || m.comment.toLowerCase().includes(keyword)
                );
            }

            // í•„í„° (ë³„ì )
            const filterVal = $filterStar.val();
            if (filterVal !== 'all') {
                const minStar = parseInt(filterVal);
                filtered = filtered.filter(m => (m.star.match(/â­/g) || []).length >= minStar);
            }

            // ì •ë ¬
            const sortVal = $sortSelect.val();
            if (sortVal === 'latest') {
                filtered.sort((a, b) => (a.createdAt?.seconds || 0) < (b.createdAt?.seconds || 0) ? 1 : -1);
            } else if (sortVal === 'star') {
                filtered.sort((a, b) => (b.star.match(/â­/g) || []).length - (a.star.match(/â­/g) || []).length);
            } else if (sortVal === 'likes') {
                filtered.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            }

            renderCards(filtered);
        }

        // ì¹´ë“œ ë Œë” í•¨ìˆ˜
        function renderCards(list) {
            $cardsContainer.empty();
            if (list.length === 0) {
                $cardsContainer.append('<p class="text-white text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
                return;
            }

            list.forEach(movie => {
                const card = $(`
          <div class="col" data-id="${movie.id}">
            <div class="card h-100 bg-dark text-white">
              <img src="${movie.image}" class="card-img-top" alt="${movie.title}" style="height:200px; object-fit:cover;">
              <div class="card-body d-flex flex-column justify-content-between">
                <div>
                  <h5 class="card-title">${movie.title}</h5>
                  <p>ë³„ì : ${movie.star}</p>
                  <p>${movie.comment}</p>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div>
                    <button class="btn btn-sm btn-outline-success like-btn">ğŸ‘ <span class="like-count">${movie.likes || 0}</span></button>
                    <button class="btn btn-sm btn-outline-danger dislike-btn ms-2">ğŸ‘ <span class="dislike-count">${movie.dislikes || 0}</span></button>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-primary edit-btn">ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-danger ms-2 delete-btn">ì‚­ì œ</button>
                    <button class="btn btn-sm btn-secondary ms-2 comment-toggle-btn">ğŸ’¬ ëŒ“ê¸€</button>
                  </div>
                </div>
                <div class="comment-section mt-3" style="display:none;">
                  <textarea class="form-control comment-input mb-2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                  <button class="btn btn-sm btn-success add-comment-btn mb-2">ëŒ“ê¸€ ë“±ë¡</button>
                  <div class="comment-list"></div>
                </div>
              </div>
            </div>
          </div>
        `);
                $cardsContainer.append(card);
                loadComments(movie.id, card.find('.comment-list'));
            });
        }

        // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (ì¬ê·€ì  ëŒ€ëŒ“ê¸€ ì§€ì›)
        async function loadComments(movieId, $commentList, parentId = null) {
            $commentList.empty();
            const commentsRef = collection(db, "movies", movieId, "comments");
            let q;
            if (parentId === null) {
                q = query(commentsRef, where("parentId", "==", null), orderBy("createdAt", "asc"));
            } else {
                q = query(commentsRef, where("parentId", "==", parentId), orderBy("createdAt", "asc"));
            }
            const snapshot = await getDocs(q);
            if (snapshot.empty) return;

            snapshot.forEach(docSnap => {
                const c = docSnap.data();
                const cId = docSnap.id;

                const commentHtml = $(`
          <div class="comment" data-comment-id="${cId}">
            <p>${c.text}</p>
            <div>
              <button class="btn btn-sm btn-outline-success like-comment-btn">ğŸ‘ <span class="like-count">${c.likes || 0}</span></button>
              <button class="btn btn-sm btn-outline-danger dislike-comment-btn ms-1">ğŸ‘ <span class="dislike-count">${c.dislikes || 0}</span></button>
              <span class="reply-btn ms-3">ë‹µê¸€</span>
              <span class="delete-comment-btn ms-3 text-danger" style="cursor:pointer;">ì‚­ì œ</span>
            </div>
            <div class="reply-input mt-2" style="display:none;">
              <textarea class="form-control reply-textarea mb-2" rows="2" placeholder="ë‹µê¸€ ì…ë ¥..."></textarea>
              <button class="btn btn-sm btn-primary add-reply-btn">ë“±ë¡</button>
              <button class="btn btn-sm btn-secondary cancel-reply-btn ms-2">ì·¨ì†Œ</button>
            </div>
            <div class="child-comments"></div>
          </div>
        `);

                $commentList.append(commentHtml);

                // ì¬ê·€ë¡œ ëŒ€ëŒ“ê¸€ í‘œì‹œ
                loadComments(movieId, commentHtml.find('.child-comments'), cId);
            });
        }

        // ëŒ“ê¸€ ì¶”ê°€ (ìµœìƒìœ„ or ëŒ€ëŒ“ê¸€)
        async function addComment(movieId, text, parentId = null) {
            if (!text.trim()) {
                alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            const commentsRef = collection(db, "movies", movieId, "comments");
            await addDoc(commentsRef, {
                text,
                parentId,
                likes: 0,
                dislikes: 0,
                createdAt: serverTimestamp()
            });
            await loadMovies();
        }

        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì˜í™” ë°˜ì˜
        async function updateMovieLikes(movieId, isLike) {
            const movieRef = doc(db, "movies", movieId);
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(movieRef);
                if (!docSnap.exists()) return;
                const currentLikes = docSnap.data().likes || 0;
                const currentDislikes = docSnap.data().dislikes || 0;
                if (isLike) {
                    transaction.update(movieRef, { likes: currentLikes + 1 });
                } else {
                    transaction.update(movieRef, { dislikes: currentDislikes + 1 });
                }
            });
            await loadMovies();
        }

        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ëŒ“ê¸€ ë°˜ì˜
        async function updateCommentLikes(movieId, commentId, isLike) {
            const commentRef = doc(db, "movies", movieId, "comments", commentId);
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(commentRef);
                if (!docSnap.exists()) return;
                const currentLikes = docSnap.data().likes || 0;
                const currentDislikes = docSnap.data().dislikes || 0;
                if (isLike) {
                    transaction.update(commentRef, { likes: currentLikes + 1 });
                } else {
                    transaction.update(commentRef, { dislikes: currentDislikes + 1 });
                }
            });
            await loadMovies();
        }

        // ì‚­ì œ (ì˜í™”)
        async function deleteMovie(movieId) {
            if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
            await deleteDoc(doc(db, "movies", movieId));
            await loadMovies();
        }

        // ì‚­ì œ (ëŒ“ê¸€)
        async function deleteComment(movieId, commentId) {
            if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
            await deleteDoc(doc(db, "movies", movieId, "comments", commentId));
            await loadMovies();
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©

        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” (ì˜í™”)
        $(document).on('click', '.like-btn', async function () {
            const movieId = $(this).closest('.col').data('id');
            await updateMovieLikes(movieId, true);
        });

        $(document).on('click', '.dislike-btn', async function () {
            const movieId = $(this).closest('.col').data('id');
            await updateMovieLikes(movieId, false);
        });

        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” (ëŒ“ê¸€)
        $(document).on('click', '.like-comment-btn', async function () {
            const $commentDiv = $(this).closest('.comment');
            const commentId = $commentDiv.data('comment-id');
            const movieId = $(this).closest('.col').data('id');
            await updateCommentLikes(movieId, commentId, true);
        });

        $(document).on('click', '.dislike-comment-btn', async function () {
            const $commentDiv = $(this).closest('.comment');
            const commentId = $commentDiv.data('comment-id');
            const movieId = $(this).closest('.col').data('id');
            await updateCommentLikes(movieId, commentId, false);
        });

        // ì‚­ì œ (ì˜í™”)
        $(document).on('click', '.delete-btn', async function () {
            const movieId = $(this).closest('.col').data('id');
            await deleteMovie(movieId);
        });

        // ì‚­ì œ (ëŒ“ê¸€)
        $(document).on('click', '.delete-comment-btn', async function () {
            const $commentDiv = $(this).closest('.comment');
            const commentId = $commentDiv.data('comment-id');
            const movieId = $(this).closest('.col').data('id');
            await deleteComment(movieId, commentId);
        });

        // ìˆ˜ì • (ì˜í™”)
        $(document).on('click', '.edit-btn', function () {
            const card = $(this).closest('.col');
            const docId = card.data('id');
            const image = card.find('img').attr('src');
            const title = card.find('.card-title').text();
            const star = card.find('p').eq(0).text().replace("ë³„ì : ", "");
            const comment = card.find('p').eq(1).text();

            $inputImage.val(image);
            $inputTitle.val(title);
            $inputStar.val(star);
            $inputComment.val(comment);
            editingId = docId;
            $postingBox.show();
        });

        // ëŒ“ê¸€ í† ê¸€
        $(document).on('click', '.comment-toggle-btn', function () {
            const $section = $(this).closest('.card-body').find('.comment-section');
            $section.toggle();
        });

        // ëŒ“ê¸€ ë“±ë¡ (ìµœìƒìœ„)
        $(document).on('click', '.add-comment-btn', async function () {
            const $card = $(this).closest('.card');
            const movieId = $card.closest('.col').data('id');
            const $textarea = $(this).siblings('.comment-input');
            const text = $textarea.val();
            await addComment(movieId, text);
            $textarea.val('');
        });

        // ë‹µê¸€ ë²„íŠ¼ í´ë¦­
        $(document).on('click', '.reply-btn', function () {
            const $comment = $(this).closest('.comment');
            $comment.find('.reply-input').show();
        });

        // ë‹µê¸€ ë“±ë¡
        $(document).on('click', '.add-reply-btn', async function () {
            const $replyInput = $(this).closest('.reply-input');
            const text = $replyInput.find('.reply-textarea').val();
            if (!text.trim()) {
                alert("ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            const $comment = $(this).closest('.comment');
            const commentId = $comment.data('comment-id');
            const movieId = $(this).closest('.col').data('id');
            await addComment(movieId, text, commentId);
            $replyInput.hide();
            $replyInput.find('.reply-textarea').val('');
        });

        // ë‹µê¸€ ì·¨ì†Œ
        $(document).on('click', '.cancel-reply-btn', function () {
            const $replyInput = $(this).closest('.reply-input');
            $replyInput.hide();
            $replyInput.find('.reply-textarea').val('');
        });

        // ê²€ìƒ‰, í•„í„°, ì •ë ¬ ì´ë²¤íŠ¸
        $searchInput.on('input', applyFiltersAndRender);
        $filterStar.on('change', applyFiltersAndRender);
        $sortSelect.on('change', applyFiltersAndRender);

        // ì´ˆê¸° ë¡œë”©
        $(async () => {
            await loadMovies();
        });

    </script>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-white">ì‚¬ì§„ì €ì¥ì†Œ</h1>
        <button id="savebtn" class="btn btn-light mb-3">ì‚¬ì§„ ê¸°ë¡í•˜ê¸°</button>

        <div class="mypostingbox" id="postingbox" style="display: none;">
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="image" placeholder="ì˜í™” ì´ë¯¸ì§€ ì£¼ì†Œ" />
                <label for="image">ì´ë¯¸ì§€ ì£¼ì†Œ</label>
            </div>
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="title" placeholder="ì˜í™” ì œëª©" />
                <label for="title">ì‚¬ì§„ ì œëª©</label>
            </div>
            <div class="form-floating mb-3">
                <select class="form-select" id="star">
                    <option selected>ë³„ì ì„ íƒ</option>
                    <option value="â­">â­</option>
                    <option value="â­â­">â­â­</option>
                    <option value="â­â­â­">â­â­â­</option>
                    <option value="â­â­â­â­">â­â­â­â­</option>
                    <option value="â­â­â­â­â­">â­â­â­â­â­</option>
                </select>
                <label for="star">ë³„ì </label>
            </div>
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="comment" placeholder="ì¶”ì²œ ì´ìœ " />
                <label for="comment">ì¶”ì²œ ì´ìœ </label>
            </div>
            <button id="postingbtn" type="button" class="btn btn-danger">ê¸°ë¡í•˜ê¸°</button>
        </div>

        <div class="mycards">
            <div id="card" class="row row-cols-1 row-cols-md-4 g-4"></div>
        </div>
    </div>
</body>

</html>
